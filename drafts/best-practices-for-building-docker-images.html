<!DOCTYPE html>
<html lang="cn">
<head>
      <title> 制作镜像的最佳实践 - 代码杂货铺</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/bootstrap.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/bootstrap-theme.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/pygment.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/main.css" type="text/css" charset="utf-8">
    <script src="https://xcodest.me/theme/js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://xcodest.me/theme/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://xcodest.me/theme/js/xcodest.js" type="text/javascript" charset="utf-8"></script>
    <link rel="icon" type="image/png" href="https://xcodest.me/theme/img/favicon.ico">
    <link href="https://xcodest.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="代码杂货铺 RSS Feed" />
</head>

<body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12">
          <div class="navbar navbar-default">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="offcanvas" data-target="#sidebar">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://xcodest.me">
                  代码杂货铺
                </a>
              </div>
              <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                  <li><a href="/archives.html">Archives</a></li>
                  <li><a href="/tags.html">Tags</a></li>
                  <li>
                    <a href="https://xcodest.me/pages/about.html">About</a>
                  </li>
                  <li>
                    <a href="https://xcodest.me/pages/opensource-books.html">Opensource books</a>
                  </li>
                </ul>
                <form class="navbar-form navbar-right" action="https://google.com/search" target="_blank">
                  <div class="input-group">
                    <input name="q" type="text" class="form-control" required placeholder="Search Xcodest.com..."/>
                    <input type="hidden" name="sitesearch" value="xcodest.me"/>
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit">
                        <i class="glyphicon glyphicon-search"></i>
                      </button>
                    </span>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-offset-1 col-md-2 col-xs-12 hidden-xs hidden-sm" id="sidebar">
          <div class="panel panel-default">
            <div class="panel-heading">欢迎订阅我的公众号</div>
            <div class="list-group">
               <img class="qrcode" src="https://xcodest.me/images/qrcode.jpg"/>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Social</div>
            <div class="list-group">
 
              <a class="list-group-item" href="http://github.com/jeffrey4l" target="_blank">Github</a>
 
              <a class="list-group-item" href="https://twitter.com/Jeffrey4l" target="_blank">Twitter</a>
 
              <a class="list-group-item" href="http://weibo.com/jeffrey4l" target="_blank">微博</a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Categories</div>
            <div class="list-group">
              <a class="list-group-item" href="https://xcodest.me/category/ceph.html">Ceph<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/cloud.html">Cloud<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/container.html">Container<span class="badge">2</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/database.html">Database<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/life.html">Life<span class="badge">3</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/linux.html">Linux<span class="badge">18</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/openstack.html">OpenStack<span class="badge">20</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/ops.html">Ops<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/others.html">Others<span class="badge">5</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/programming.html">Programming<span class="badge">5</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/python.html">Python<span class="badge">2</span></a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Blogroll</div>
            <div class="list-group">
              <a class="list-group-item" href="http://99cloud.net" target="_blank">99cloud(九州云)</a>
              <a class="list-group-item" href="http://chenshake.com/" target="_blank">陈沙克日志</a>
              <a class="list-group-item" href="http://coolshell.cn" target="_blank">酷壳 - CoolShell.Cn</a>
              <a class="list-group-item" href="https://sdake.io/" target="_blank">Steven Dake</a>
              <a class="list-group-item" href="https://sebastien-han.fr/" target="_blank">SÉBASTIEN HAN</a>
              <a class="list-group-item" href="http://blog.csdn.net/quqi99" target="_blank">技术并艺术着</a>
            </div>
          </div>
        </div>
        <div class="col-md-8 col-xs-12">
<div class="row">
  <div class="col-md-12 col-xs-12">
  <section id="content" class="body">
  <header>
    <h1 class="entry-title">制作镜像的最佳实践</h1>
    <div class="entry-info">
      <span class="glyphicon glyphicon-list-alt"></span>
      <span class="post-date"> 2018-10-03 </span>
      <!--
      <a class="post-category label label-default" href="https://xcodest.me/category/others.html">Others</a>
      -->
      <span class="glyphicon glyphicon-tags"></span>
    </div>
  </header>
  <div class="entry-content">
    <h2 id="_1">构建体积更小的镜像</h2>
<p>构建体积更小的镜像，有利于镜像本身的传输，尤其在 Kubernetes 的环境中，镜像的传输会更加频繁，更小的体积意味着更快的调度时间和更小的空间占用。那如何构建更加小的镜像呢?</p>
<h3 id="_2">使用更小的基础镜像</h3>
<p>不同的基础镜像构建相同的应用会有不同的大小。使用更小基础镜像会有利于减小最终镜像的大小。建议非特殊情况下，使用 alpine 镜像。他的基础镜像只有不到 5MB, 而且还自带包管理工具。一般需求都可以满足。</p>
<div class="highlight"><pre><span></span>FROM alpine
RUN apk add nginx
</pre></div>


<p>如果你的应用可以独立运行，如 Go 编译出来的 Binary 文件，还可以直接使用 scratch 这个空白镜像。</p>
<div class="highlight"><pre><span></span>FROM scratch
COPY mybinary /mybinary
CMD [ &quot;/mybinary&quot; ]
</pre></div>


<h3 id="run">合并 RUN 命令</h3>
<p>不同的 RUN 命令如果先后做了文件的增加和删除，因为镜像分层文件系统的原因，还是会增加镜像体积的。如果两个 RUN 命令合并后，才会达到所想的效果。</p>
<div class="highlight"><pre><span></span>...
RUN curl http://xyz.abc -o abc.tar.gz \
    ...
    rm -rf abc.tar.gz
...
</pre></div>


<h3 id="_3">去除掉不用的软件包</h3>
<p>在安装包的过程中，尽量只安装需要用到的包。尤其是在编译过程中，难免会安装一些运行过程中不需要的软件包，如 glibc-devel 等。那在最后，最好把这些包去掉，来节省镜像空间。又因为镜像分层系统的原因，这些安装和卸载的语法还应该处理同一个 RUN 命令下</p>
<div class="highlight"><pre><span></span>...
RUN BUILD_DEP_PKGS=&quot;
       gcc \
       libc-devel&quot;
    &amp;&amp; yum -y install $BUILD_DEP_PKGS \
    ...
    &amp;&amp; yum -y remove $BUILD_DEP_PKGS
...
</pre></div>


<h3 id="_4">只安装必要依赖包的</h3>
<p><code>apt</code> 和 <code>yum/dnf</code> 在安装包的过程中，默认会自动安装一些弱依赖包。一般情况下是使用不到的。可以显示的关闭弱依赖。</p>
<div class="highlight"><pre><span></span><span class="x"># apt-get for Debian family</span>
<span class="x">apt-get -y install --no-install-recommends </span><span class="cp">{{</span> <span class="nv">package</span> <span class="cp">}}</span><span class="x"> </span>

<span class="x"># yum from RHEL family</span>
<span class="x">yum -y --setopt=install_weak_deps=false \</span>
<span class="x">    --setopt=tsflags=nodocs \</span>
<span class="x">    --setopt=override_install_langs=en_US.utf8 \</span>
<span class="x">    install vim</span>
</pre></div>


<ul>
<li><code>--no-install-recommends</code> : 不安装推荐依赖</li>
<li><code>--setopt=install_weak_deps=false</code>: 不安装弱依赖包</li>
<li><code>--setopt=tsflags=nodocs</code>: 不安装文档包</li>
<li><code>--setopt=override_install_langs=en_US.utf8</code>: 设置默认语言为 <code>en_US.utf8</code></li>
</ul>
<h3 id="lastlog-faillog">关闭用户初始化 lastlog 和 faillog 数据库</h3>
<p>如果你要在镜像中创建新的用户，可以不初始化用户相关的 lastlog 和  faillog 数据库[1]。可以使用 <code>useradd -l</code> 或把 <code>/var/log/faillog</code> 和 <code>/var/log/lastlog</code> 文件删除掉，彻底关掉该功能。每个用户大概用占用掉 4k 左右的空间。</p>
<h3 id="multi-stage">使用 multi stage 构建</h3>
<p>对于很多需要编译运行的程序，如 Java, C, Golang 等，其编译环境和运行环境是不一样的，为了减小最终镜像的大小，我们可以使用上面提到的合并 <code>RUN</code> 命令的方式，但是看着会比较乱，比较难以维护。docker daemon &gt;= 17.05 [^3]版本的时候支持 multi stage 构建，解决了此类问题，他使用两个镜像来构建，通过 <code>COPY --from</code> 语法，在两个镜像之间传递构建好的文件。使用方法如下：</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> golang:1.7.3 as builder</span>
<span class="k">WORKDIR</span><span class="s"> /go/src/github.com/alexellis/href-counter/</span>
<span class="k">RUN</span> go get -d -v golang.org/x/net/html  
<span class="k">COPY</span> app.go    .
<span class="k">RUN</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="nv">GOOS</span><span class="o">=</span>linux go build -a -installsuffix cgo -o app .

<span class="k">FROM</span><span class="s"> alpine:latest  </span>
<span class="k">RUN</span> apk --no-cache add ca-certificates
<span class="k">WORKDIR</span><span class="s"> /root/</span>
<span class="k">COPY</span> --from<span class="o">=</span>builder /go/src/github.com/alexellis/href-counter/app .
<span class="k">CMD</span> <span class="p">[</span><span class="s2">&quot;./app&quot;</span><span class="p">]</span>  
</pre></div>


<p>它使用 <code>golang:1.7.3</code> 做为构建镜像，来构建出名为 <code>app</code> 的应用，然后把  <code>app</code> 再拷贝到以 <code>alpine:latest</code> 为基础的镜像里面，这样做出来的镜像肯定会很小。</p>
<h2 id="_5">缩小镜</h2>
<h2 id="_6">像体积</h2>
<h3 id="dive">使用 dive 分析镜像的空间占用</h3>
<p><a href="https://github.com/wagoodman/dive" target="_blank">dive</a> 是一个命令行工具，可以分析镜像里面每层的空间占用大小，有助于发现问题，以减少镜像大小。</p>
<p><img alt="dive example" src="images/2018/dive-demo.gif"></p>
<h3 id="_7">合并镜像的多个层</h3>
<p>docker 自从 1.13 版本增加了一个 squash 的 <code>experimental</code>特性 [^2]。他可以把把当前 Dockerfile 文件里面的多个层在构建的时候自动合并成一个。但是不支持合并其父镜像。使用前，需要打开 docker daemon 的 experiment 特性。使用方法如下</p>
<div class="highlight"><pre><span></span>$ docker build --squash .
</pre></div>


<p>除了这个方法，还有一个工具叫 <a href="https://github.com/goldmann/docker-squash" target="_blank">docker squash</a> ， 他支持合并镜像的任意层。使用方法如下</p>
<div class="highlight"><pre><span></span>$ pip install docker-squash
$ docker-squash -t kolla/centos-source-base:new <span class="se">\</span>
      kolla/centos-source-base:master
Old image has <span class="m">40</span> layers
Attempting to squash last <span class="m">40</span> layers...
...
Original image size: <span class="m">388</span>.51 MB
Squashed image size: <span class="m">281</span>.43 MB
Image size decreased by <span class="m">27</span>.56 %
Image registered in Docker daemon as kolla/centos-source-base:new
</pre></div>


<p>可以看到，通过 <code>squash</code> 镜像大小从 <code>388.51MB</code> 缩小到了 <code>281.43MB</code> ，缩小了 <code>27.56%</code> 。</p>
<blockquote>
<p>注意：在使用 squash 的时候，会消耗大量的硬盘 IO，如果硬盘性能不好，速度会比较慢。</p>
</blockquote>
<h2 id="_8">镜像安全</h2>
<h3 id="init">init 进程</h3>
<p>重启容器的时候，经常会很慢，而且docker daemon 日志中经常会抛出以下错误</p>
<div class="highlight"><pre><span></span>dockerd[559]: msg=&quot;Container 5054f failed to exit within 10 seconds of signal 15 - using the force&quot;
</pre></div>


<p>默认的的 signal 15 根本就没有使其退出，最后还是 10 秒超时后强制退出(kill)的。而且有时还会出现大量僵尸进程。</p>
<p>容器化后，由于单容器单进程，已经没有传统意义上的 init 进程。应用进程直接占用了 pid 1 的进程号，应用默认是不会处理<code>SIGTERM</code> 信号的，所以会导致 signal 15 不能使进程正常退出，只能使用 <code>SIGKILL</code> 直接杀死进程。而这可能导致某些资源不能正常回收。另外 pid 1 进程还需要负责其子进程的回收工作，但是一般应用也不会对此进行处理。所以会导致僵尸进程的出现。更多解释，请参看我写的另外一篇文章：<a href="docker-init-process" target="_blank">Docker init 进程</a></p>
<p>解决方案是使用 <a href="https://github.com/krallin/tini" target="_blank">tini</a> , 或 <a href="ttps://github.com/Yelp/dumb-init" target="_blank">dumb-init</a> 等轻量级 init 进程。所以在制作镜像的时候最好安装上其中一个。</p>
<div class="highlight"><pre><span></span><span class="c"># install dumb-init</span>
<span class="k">RUN</span> wget -O /usr/local/bin/dumb-init <span class="se">\</span>
    https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64
<span class="k">RUN</span> chmod +x /usr/local/bin/dumb-init

<span class="c"># Runs &quot;/usr/bin/dumb-init -- /my/script --with --args&quot;</span>
<span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/dumb-init&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">]</span>
<span class="k">CMD</span> <span class="p">[</span><span class="s2">&quot;/my/script&quot;</span><span class="p">,</span> <span class="s2">&quot;--with&quot;</span><span class="p">,</span> <span class="s2">&quot;--args&quot;</span><span class="p">]</span>
</pre></div>


<p>如果是使用 docker 的情况下，docker 自 1.13 之后已经自带一个 init 进程，其实就是  tini, 使用方法如下</p>
<div class="highlight"><pre><span></span>$ docker run --init centos:7 ps auxf
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         <span class="m">1</span>  <span class="m">0</span>.0  <span class="m">0</span>.0   <span class="m">1000</span>     <span class="m">4</span> ?        Ss   <span class="m">03</span>:45   <span class="m">0</span>:00 /dev/init -- ps auxf
root         <span class="m">6</span>  <span class="m">0</span>.0  <span class="m">0</span>.0  <span class="m">51748</span>  <span class="m">3444</span> ?        R    <span class="m">03</span>:45   <span class="m">0</span>:00 ps auxf
</pre></div>


<h3 id="drop-root">Drop root</h3>
<p>虽然 container 在运行的时候 ，是与系统隔离开的，但是如果你使用 root 运行容器的话，他在系统层面上看，也是 root 账号，权限是比较大的，<a href="https://security.stackexchange.com/questions/176206/docker-runs-container-processes-as-root-should-i-be-worried" target="_blank">会有一定的风险</a>。更安全的做法是使用非root 账号运行。这点在 openshift 上面体现的比较明显，他默认是使用一个很大的 uid 来运行，来限制容器内的进程权限。</p>
<p>在使用非 root 账号运行，尤其是在 kubernetes/openshift 这种环境中，uid 是不能事先确认的，需要对读写目录标记上<code>0777</code> 的权限。包括某些可能通过  volume 挂载的目录。</p>
<blockquote>
<p>注意，对于 volume 挂载的目录，在 kubernetes/openshift 环境中，并不是必要的，volume 目录的 uid / gid 会由 kubelet 自动配置好。</p>
</blockquote>
<p>例子如下</p>
<div class="highlight"><pre><span></span><span class="k">RUN</span> ... <span class="se">\</span>
    <span class="o">&amp;&amp;</span> rm -rf /etc/nginx/*.default <span class="se">\</span>
    <span class="o">&amp;&amp;</span> chmod -R a+rwx <span class="si">${</span><span class="nv">NGINX_HOME_TMP</span><span class="si">}</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> chmod -R a+rwx /etc/nginx <span class="se">\</span>
    <span class="o">&amp;&amp;</span> chmod -R a+rwx /var/log/nginx <span class="se">\</span>
    <span class="o">&amp;&amp;</span> chmod -R a+rwx /var/run/nginx
</pre></div>


<p>把需要  nginx 读写的地方配置上  <code>rwx</code> 权限，这样不管 nginx 进程的 <code>uid</code>  是多少，都可以正常运行。</p>
<h2 id="tag">镜像 tag 管理</h2>
<p>理论上讲，docker 的镜像内容是不可变的，其 tag 应该是和 git 的 tag 是一样的，应该是一个只读值不应该变化。但是平时大家在使用的时候，习惯的使用 <code>:latest</code> ， 这样在生产环境中是比较危险的，很容易搞错镜像。我建议使用如下风格的 tag 命令方式来管理 image.</p>
<div class="highlight"><pre><span></span>X.Y.Z-N

X.Y.Z 跟随镜像里面关联代码的版本号
N 使用构建次数，或使用时间戳。来标记 Dockerfile 的变化及构建时间
</pre></div>


<h2 id="_9">其它镜像构建方式</h2>
<p>现在，除了 <code>Dockerfile</code> 这种构建方式，还有很多其它的镜像构建工具，有兴趣可以深入研究下</p>
<ul>
<li><a href="https://github.com/openshift/source-to-image" target="_blank">source to image</a>: openshift 里面带的一个方便由源代码直接生成镜像的方案，可以单独使用。</li>
<li><a href="https://github.com/uber/makisu" target="_blank">makisu</a>: 方便在  kubernetes 环境中使用的镜像构建方案，可以 unprivileged 的容器中使用</li>
<li><a href="https://github.com/containers/buildah" target="_blank">buildash</a>: 构建 OCI 兼容格式镜像工具。</li>
</ul>
<h2 id="demo">Demo</h2>
<div class="highlight"><pre><span></span>FROM centos:7

EXPOSE 8080
EXPOSE 8443

ARG http_proxy
ARG https_proxy

ARG NGINX_MODULE_VTS_VERSION=v0.1.18
ARG NGINX_VERSION=1.13.3
ARG TINI_VERSION=v0.18.0

ENV NGINX_GROUP nginx
ENV NGINX_HOME_TMP /var/spool/nginx/tmp
ENV NGINX_HOME /var/lib/nginx
ENV NGINX_USER nginx

ENV NGINX_DOWNLOAD_URL http://nginx.org/download/nginx-<span class="cp">${</span><span class="n">NGINX_VERSION</span><span class="cp">}</span>.tar.gz

RUN BUILD_DEP_PKGS=&quot;\
        cpp \
        expat-devel \
        fontconfig-devel \
        freetype-devel \
        gcc \
        gd-devel \
        git \
        glibc-devel \
        glibc-headers \
        kernel-headers \
        keyutils-libs-devel \
        krb5-devel \
        libcom_err-devel \
        libjpeg-turbo-devel \
        libpng-devel \
        libselinux-devel \
        libsepol-devel \
        libverto-devel \
        libX11-devel \
        libXau-devel \
        libxcb-devel \
        libxcb-devel \
        libXpm-devel \
        make \
        openssl-devel \
        pcre-devel \
        xorg-x11-proto-devel \
        zlib-devel \
        &quot; \
    <span class="err">&amp;&amp;</span> rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 \
    <span class="err">&amp;&amp;</span> yum -y --setopt=install_weak_deps=false --setopt=tsflags=nodocs --setopt=override_install_langs=en_US.utf8 \
        install \
        <span class="cp">${</span><span class="n">BUILD_DEP_PKGS</span><span class="cp">}</span> \
        rsync \
        wget \
    <span class="err">&amp;&amp;</span> curl -L https://github.com/krallin/tini/releases/download/<span class="cp">${</span><span class="n">TINI_VERSION</span><span class="cp">}</span>/tini -o /tini \
    <span class="err">&amp;&amp;</span> chmod +x /tini \
    <span class="err">&amp;&amp;</span> wget <span class="cp">${</span><span class="n">NGINX_DOWNLOAD_URL</span><span class="cp">}</span> -O /tmp/nginx.tar.gz \
    <span class="err">&amp;&amp;</span> tar xf /tmp/nginx.tar.gz -C /tmp \
    <span class="err">&amp;&amp;</span> git clone --branch <span class="cp">${</span><span class="n">NGINX_MODULE_VTS_VERSION</span><span class="cp">}</span> https://github.com/vozlt/nginx-module-vts.git /tmp/nginx-module-vts \
    <span class="err">&amp;&amp;</span> ( \
        cd /tmp/nginx-<span class="cp">${</span><span class="n">NGINX_VERSION</span><span class="cp">}</span> \
        <span class="err">&amp;&amp;</span> ./configure \
                --add-module=/tmp/nginx-module-vts \
                --conf-path=/etc/nginx/nginx.conf \
                --error-log-path=/var/log/nginx/error.log \
                --group=<span class="cp">${</span><span class="n">NGINX_GROUP</span><span class="cp">}</span> \
                --http-client-body-temp-path=<span class="cp">${</span><span class="n">NGINX_HOME_TMP</span><span class="cp">}</span>/client_body \
                --http-fastcgi-temp-path=<span class="cp">${</span><span class="n">NGINX_HOME_TMP</span><span class="cp">}</span>/fastcgi \
                --http-log-path=/var/log/nginx/access.log \
                --http-proxy-temp-path=<span class="cp">${</span><span class="n">NGINX_HOME_TMP</span><span class="cp">}</span>/proxy \
                --http-uwsgi-temp-path=<span class="cp">${</span><span class="n">NGINX_HOME_TMP</span><span class="cp">}</span>/uwsgi \
                --lock-path=/var/local/subsys/nginx \
                --modules-path=/usr/lib64/nginx/modules \
                --pid-path=/var/run/nginx/nginx.pid \
                --prefix=/etc/nginx \
                --sbin-path=/usr/bin/nginx \
                --user=<span class="cp">${</span><span class="n">NGINX_USER</span><span class="cp">}</span> \
                --with-http_gzip_static_module \
                --with-http_image_filter_module \
                --with-http_realip_module \
                --with-http_secure_link_module \
                --with-http_ssl_module \
                --with-http_stub_status_module \
                --with-http_sub_module \
                --with-http_v2_module \
                --without-http_scgi_module \
                --without-mail_imap_module \
                --without-mail_pop3_module \
                --without-mail_smtp_module \
                --without-poll_module \
                --without-select_module \
                --with-threads \
        <span class="err">&amp;&amp;</span> make -j4 \
        <span class="err">&amp;&amp;</span> make install \
        <span class="err">&amp;&amp;</span> cp -r conf/* /etc/nginx/ \
        ) \
    <span class="err">&amp;&amp;</span> rm -rf /tmp/nginx.tar.gz \
        /tmp/nginx-module-vts \
        /tmp/nginx-<span class="cp">${</span><span class="n">NGINX_VERSION</span><span class="cp">}</span> \
    <span class="err">&amp;&amp;</span> yum -y remove <span class="cp">${</span><span class="n">BUILD_DEP_PKGS</span><span class="cp">}</span> \
    <span class="err">&amp;&amp;</span> yum clean all \
    <span class="err">&amp;&amp;</span> mkdir -p <span class="cp">${</span><span class="n">NGINX_HOME_TMP</span><span class="cp">}</span>/{client_body,proxy,fastcgi,uwsgi} \
    <span class="err">&amp;&amp;</span> mkdir -p /usr/share/nginx \
    <span class="err">&amp;&amp;</span> mkdir -p /var/run/nginx \
    <span class="err">&amp;&amp;</span> mkdir -p /var/www \
    <span class="err">&amp;&amp;</span> mv /etc/nginx/html /usr/share/nginx/ \
    <span class="err">&amp;&amp;</span> rm -rf /etc/nginx/*.default \
    <span class="err">&amp;&amp;</span> chmod -R a+rwx <span class="cp">${</span><span class="n">NGINX_HOME_TMP</span><span class="cp">}</span> \
    <span class="err">&amp;&amp;</span> chmod -R a+rwx /etc/nginx \
    <span class="err">&amp;&amp;</span> chmod -R a+rwx /var/log/nginx \
    <span class="err">&amp;&amp;</span> chmod -R a+rwx /var/run/nginx \
    <span class="err">&amp;&amp;</span> sed -i &#39;/listen/s,listen\s*80;,listen 8080;,g&#39; /etc/nginx/nginx.conf \
    <span class="err">&amp;&amp;</span> sed -i &#39;/^#user/s,#\(user.*\),\1,g&#39; /etc/nginx/nginx.conf \
    <span class="err">&amp;&amp;</span> ln -sf /var/log/nginx /etc/nginx/logs \
    <span class="err">&amp;&amp;</span> ln -sf /var/www /etc/nginx/www
</pre></div>


<h2 id="ref">REF</h2>
<ul>
<li>[^1]: https://github.com/sagemathinc/cocalc/issues/2287#issue-249824529</li>
<li>[^2]: https://docs.docker.com/engine/reference/commandline/build/#squash-an-images-layers---squash-experimental</li>
<li>[^3]: <a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank">https://docs.docker.com/develop/develop-images/multistage-build/</a> </li>
<li>[^4]: <a href="https://www.weave.works/blog/10-tips-for-building-and-managing-containers" target="_blank">10 tips for building and managing containers</a></li>
</ul>
    <div class="copyright">
      <p><span>原始链接:</span><a href="http://xcodest.me/drafts/best-practices-for-building-docker-images.html" target="_blank">http://xcodest.me/drafts/best-practices-for-building-docker-images.html </a></p>
      <p> <span>许可协议:</span><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
    </div>
  </div><!-- /.entry-content -->
</section>
</div>
</div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12 text-center footer">
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41808584-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257099267'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1257099267' type='text/javascript'%3E%3C/script%3E"));</script>
        </div>
    </div>
</body>
</html>