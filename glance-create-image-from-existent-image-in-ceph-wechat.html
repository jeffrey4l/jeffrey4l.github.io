<html>
<head>
    <meta http-equiv=Content-Type content="text/html;charset=utf-8">
    <link rel="stylesheet" href="theme/css/wechat.css" type="text/css" charset="utf-8">
</head>
<body>
  <p>当使用 Ceph + Glance 时，镜像需要使用 RAW 格式，这会导致创建镜像时非常的慢。有的时候，也需要把 Ceph 中现有的镜像导入到 Glance 中。这时可以使用 --location 参数来指定镜像所在的远程位置。也就可以使用现有的 Ceph 镜像来快速创建。</p>
<p>可以先用 rbd 上传镜像，转换格式(也会比较慢，还不如直接上传 RAW 格式的镜像)。然后再做好对应的 snap , 并加以保护。是后一步的location必须按格式写(见[0])，这样才会使用rbd的 COW clone 功能。</p>
<pre class="codehilite"><code class="language-shell"># image format 2 support layering
rbd --image-format 2 import /tmp/ubuntu14.04.2.dsk $uuid

# Convert to raw image type
qemu-img convert -O raw rbd:$pool/$uuid rbd:$pool/$uuid

# Make Snapshot and protect it which is require by image clone in nova libvirt.
rbd --pool images snap create --snap snap $uuid
rbd --pool images snap protect --image $uuid --snap snap

# Create Image in Glance
glance image-create --id $uuid --name ubuntu14.04.2 --disk-format raw --container-format bare --is-public True --location rbd://$fsid/images/$uuid/snap</code></pre>


<h1 id="ref">REF</h1>
<ul>
<li>[0] <a href="https://github.com/openstack/nova/blob/4a02d9415f64e8d579d1b674d6d2efda902b01fa/nova/virt/libvirt/rbd_utils.py#L179">https://github.com/openstack/nova/blob/4a02d9415f64e8d579d1b674d6d2efda902b01fa/nova/virt/libvirt/rbd_utils.py#L179</a></li>
<li>[1] <a href="http://www.sebastien-han.fr/down/OpenStack%20_%20Ceph%20-%20Liberty.pdf">http://www.sebastien-han.fr/down/OpenStack%20_%20Ceph%20-%20Liberty.pdf</a></li>
<li>[2] <a href="http://www.sebastien-han.fr/blog/2013/05/07/use-existing-rbd-images-and-put-it-into-glance/">http://www.sebastien-han.fr/blog/2013/05/07/use-existing-rbd-images-and-put-it-into-glance/</a></li>
</ul>
  <!--
  <div class="copyleft">
    <p>文档信息</p>
    <ul>
      <li> 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）</li>
      <li> 作者： Jeffrey4l </li>
      <li> 发表日期： 2017年12月19日 </li>
  </div>
  -->
<div>

</div>
</body>
</html>
