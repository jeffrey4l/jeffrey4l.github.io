<html>
<head>
    <meta http-equiv=Content-Type content="text/html;charset=utf-8">
    <link rel="stylesheet" href="theme/css/wechat.css" type="text/css" charset="utf-8">
</head>
<body>
  <h2 id="_1">引子</h2>
<p>很多 OpenStack 与 Ceph 部署集成的文档都会告诉你，libivrt 的文件和密码注入是在 Ceph 上面是不支持的。需要使用下面的配置文件关闭。</p>
<pre class="codehilite"><code class="language-ini">[libvirt]
inject_password = false
inject_key = false
inject_partition = -2</code></pre>


<p>但是真的只是不支持这么简单么? 首先看 nova 的注入是如何工作的。</p>
<h2 id="nova">nova 是怎么注入的文件的</h2>
<p>nova 使用 libguestfs 来文件密码的注入</p>
<p>libguestfs主要有三个大的部分：<code>guestfsd</code>, <code>guestfs-lib</code> ,<code>guestfish</code>。</p>
<p><strong>guestfsd是一个daemon</strong>，但是它不是运行在 host 上的 daemon，它运行在 guest 上，libguestfs 首先用<code>febootstrap</code>和<code>febootstrap-supermin-helper</code>两个工具将 host 中的 kernel，用得到的一些 modules，配置文件和一些工具重新组合到一起，接着在后台启动一个 qemu 进程启动这个由<code>febootstrap</code>生成的 image。在用 qemu 启动的这个 guest 里运行<code>guestfsd</code>。<code>guestfsd</code>通过 socket 和 host 进行通信，之间建立了一个通信的协议，它可以通过 socket 接受来自host端<code>guestfs-lib</code>写到 socket 的数据。guestfsd 通过分析接受到的数据，进而执行相应的操作。</p>
<p><strong>guestfs-lib是一个库</strong>，它实现了一些 libguestfs 的库函数 <code>guestfs_*</code>。这些库函数向 socket 发送相应的数据，数据就会被 guest 端的 guestfsd 接收到，进而分析所要执行的操作。 </p>
<p><strong>guestfish是对 guestfs-lib 接口函数的一些应用</strong>，guestfish 的命令都是通过调用<code>guestfs-lib</code>的库函数来实现的。</p>
<p>如果在 nova 中开启了 inject 功能，nova 会调用 libguestfs 的接口，把文件或密码注入到镜像中去，然后再去真正的启动用户的虚拟机。那支持 ceph 里面的镜像么?</p>
<h2 id="libguestfs-rbd">libguestfs 对 rbd 的支持</h2>
<p>libguestfs 对 rbd 的支持是从 1.21.21 这个版本开始的<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>，并且测试并不充分<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>, 这个版本也是13年5月份才发布的。到现在 CentOS6 上面的 libguestfs 版本还是 1.20.11。所以早期时候，文档中建议关掉 inject 功能，是确实 libguestfs 不支持RBD上面的镜像。</p>
<p>但是 CentOS7 上面，libguestfs 已经支持这个功能，所以是可以打开 nova 的注入功能的。那我们是不是就可以把这个功能打开了?</p>
<h2 id="libvirt">libvirt 注入的问题</h2>
<p><strong>不支持 Boot from volume</strong><sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>, 当从 Volume 启动的时候，并不支持文件注入。</p>
<p><strong>社区也准备废弃这个功能</strong>，有几个原因。1是代码层面上，如果注入失败了，没有任何错误信息报出来。2是文件注入并不安全。3是这些注入的文件并没有持久化(存入数据库)，在 <code>evacuate</code> 或 <code>unshelve</code> 的时候，这些文件会被丢掉。 4是可以通过 metadata-api 或 config-drive 更方便的实现文件注入功能。有兴趣可以读下相关信息<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup><sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup><sup id="fnref:6"><a class="footnote-ref" href="#fn:6" rel="footnote">6</a></sup><sup id="fnref:7"><a class="footnote-ref" href="#fn:7" rel="footnote">7</a></sup></p>
<h2 id="_2">结论</h2>
<p>通过 nova inject 注入的方式并不被社区推荐，应该采用 metadata-api 或 config drive 方式才是更加可取。</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://github.com/libguestfs/libguestfs/commit/694a091d3faac78acbd0b5a368856b569c7ba5e2">https://github.com/libguestfs/libguestfs/commit/694a091d3faac78acbd0b5a368856b569c7ba5e2</a>&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="https://github.com/libguestfs/libguestfs/commit/186bb67c6e8496d04a6f5646df9b2fb483cdc189">https://github.com/libguestfs/libguestfs/commit/186bb67c6e8496d04a6f5646df9b2fb483cdc189</a>&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><a href="https://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L3269">https://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L3269</a>&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p><a href="http://lists.openstack.org/pipermail/openstack-dev/2016-November/107195.html">http://lists.openstack.org/pipermail/openstack-dev/2016-November/107195.html</a>&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p><a href="http://lists.openstack.org/pipermail/openstack-dev/2016-July/098703.html">http://lists.openstack.org/pipermail/openstack-dev/2016-July/098703.html</a>&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p><a href="http://lists.openstack.org/pipermail/openstack-dev/2017-March/113171.html">http://lists.openstack.org/pipermail/openstack-dev/2017-March/113171.html</a>&#160;<a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p><a href="https://review.openstack.org/509013">https://review.openstack.org/509013</a>&#160;<a class="footnote-backref" href="#fnref:7" rev="footnote" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:8">
<p><a href="https://blueprints.launchpad.net/nova/+spec/disable-file-injection-by-default">https://blueprints.launchpad.net/nova/+spec/disable-file-injection-by-default</a>&#160;<a class="footnote-backref" href="#fnref:8" rev="footnote" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  <!--
  <div class="copyleft">
    <p>文档信息</p>
    <ul>
      <li> 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）</li>
      <li> 作者： Jeffrey4l </li>
      <li> 发表日期： 2017年12月19日 </li>
  </div>
  -->
<div>

</div>
</body>
</html>
