<!DOCTYPE html>
<html lang="cn">
<head>
      <title> MySQL Errno 150 - 代码杂货铺</title>
    <meta charset="utf-8" />

    <meta name="tags" contents="MySQL" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/bootstrap.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/bootstrap-theme.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/pygment.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/main.css" type="text/css" charset="utf-8">
    <script src="https://xcodest.me/theme/js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://xcodest.me/theme/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://xcodest.me/theme/js/xcodest.js" type="text/javascript" charset="utf-8"></script>
    <link rel="icon" type="image/png" href="https://xcodest.me/theme/img/favicon.ico">
    <link href="https://xcodest.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="代码杂货铺 RSS Feed" />
</head>

<body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12">
          <div class="navbar navbar-default">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="offcanvas" data-target="#sidebar">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://xcodest.me">
                  代码杂货铺
                </a>
              </div>
              <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                  <li><a href="/archives.html">Archives</a></li>
                  <li><a href="/tags.html">Tags</a></li>
                  <li>
                    <a href="https://xcodest.me/pages/about.html">About</a>
                  </li>
                  <li>
                    <a href="https://xcodest.me/pages/opensource-books.html">Opensource books</a>
                  </li>
                </ul>
                <form class="navbar-form navbar-right" action="https://google.com/search" target="_blank">
                  <div class="input-group">
                    <input name="q" type="text" class="form-control" required placeholder="Search Xcodest.com..."/>
                    <input type="hidden" name="sitesearch" value="xcodest.me"/>
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit">
                        <i class="glyphicon glyphicon-search"></i>
                      </button>
                    </span>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-offset-1 col-md-2 col-xs-12 hidden-xs hidden-sm" id="sidebar">
          <div class="panel panel-default">
            <div class="panel-heading">欢迎订阅我的公众号</div>
            <div class="list-group">
               <img class="qrcode" src="https://xcodest.me/images/qrcode.jpg"/>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Social</div>
            <div class="list-group">
 
              <a class="list-group-item" href="http://github.com/jeffrey4l" target="_blank">Github</a>
 
              <a class="list-group-item" href="https://twitter.com/Jeffrey4l" target="_blank">Twitter</a>
 
              <a class="list-group-item" href="http://weibo.com/jeffrey4l" target="_blank">微博</a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Categories</div>
            <div class="list-group">
              <a class="list-group-item" href="https://xcodest.me/category/ceph.html">Ceph<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/cloud.html">Cloud<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/container.html">Container<span class="badge">2</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/database.html">Database<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/life.html">Life<span class="badge">3</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/linux.html">Linux<span class="badge">18</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/openstack.html">OpenStack<span class="badge">20</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/ops.html">Ops<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/others.html">Others<span class="badge">5</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/programming.html">Programming<span class="badge">5</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/python.html">Python<span class="badge">2</span></a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Blogroll</div>
            <div class="list-group">
              <a class="list-group-item" href="http://99cloud.net" target="_blank">99cloud(九州云)</a>
              <a class="list-group-item" href="http://chenshake.com/" target="_blank">陈沙克日志</a>
              <a class="list-group-item" href="http://coolshell.cn" target="_blank">酷壳 - CoolShell.Cn</a>
              <a class="list-group-item" href="https://sdake.io/" target="_blank">Steven Dake</a>
              <a class="list-group-item" href="https://sebastien-han.fr/" target="_blank">SÉBASTIEN HAN</a>
              <a class="list-group-item" href="http://blog.csdn.net/quqi99" target="_blank">技术并艺术着</a>
            </div>
          </div>
        </div>
        <div class="col-md-8 col-xs-12">
<div class="row">
  <div class="col-md-12 col-xs-12">
  <section id="content" class="body">
  <header>
    <h1 class="entry-title">MySQL Errno 150</h1>
    <div class="entry-info">
      <span class="glyphicon glyphicon-list-alt"></span>
      <span class="post-date"> 2015-01-14 </span>
      <!--
      <a class="post-category label label-default" href="https://xcodest.me/category/linux.html">Linux</a>
      -->
      <span class="glyphicon glyphicon-tags"></span>
      <a class="post-tag label label-default" href="https://xcodest.me/tag/mysql.html">MySQL</a>
    </div>
  </header>
  <div class="entry-content">
    <p>做OpenStack icehouse 升级到 Juno过程中，升级Neutron数据库时遇到这个错误。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> python -m neutron.db.migration.migrate_to_ml2 openvswitch mysql://USER:PASSWORD@10.251.1.8/neutron
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;/usr/lib/python2.7/runpy.py&quot;, line 162, in _run_module_as_main</span>
<span class="go">    &quot;__main__&quot;, fname, loader, pkg_name)</span>
<span class="go">  File &quot;/usr/lib/python2.7/runpy.py&quot;, line 72, in _run_code</span>
<span class="go">    exec code in run_globals</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/neutron/db/migration/migrate_to_ml2.py&quot;, line 462, in &lt;module&gt;</span>
<span class="go">    main()</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/neutron/db/migration/migrate_to_ml2.py&quot;, line 458, in main</span>
<span class="go">    args.vxlan_udp_port)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/neutron/db/migration/migrate_to_ml2.py&quot;, line 138, in __call__</span>
<span class="go">    metadata.create_all(engine)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/schema.py&quot;, line 2848, in create_all</span>
<span class="go">    tables=tables)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 1479, in _run_visitor</span>
<span class="go">    conn._run_visitor(visitorcallable, element, **kwargs)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 1122, in _run_visitor</span>
<span class="go">    **kwargs).traverse_single(element)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/sql/visitors.py&quot;, line 122, in traverse_single</span>
<span class="go">    return meth(obj, **kw)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/ddl.py&quot;, line 70, in visit_metadata</span>
<span class="go">    self.traverse_single(table, create_ok=True)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/sql/visitors.py&quot;, line 122, in traverse_single</span>
<span class="go">    return meth(obj, **kw)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/ddl.py&quot;, line 89, in visit_table</span>
<span class="go">    self.connection.execute(schema.CreateTable(table))</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 662, in execute</span>
<span class="go">    params)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 720, in _execute_ddl</span>
<span class="go">    compiled</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 874, in _execute_context</span>
<span class="go">    context)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 1024, in _handle_dbapi_exception</span>
<span class="go">    exc_info</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py&quot;, line 196, in raise_from_cause</span>
<span class="go">    reraise(type(exception), exception, tb=exc_tb)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;, line 867, in _execute_context</span>
<span class="go">    context)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py&quot;, line 324, in do_execute</span>
<span class="go">    cursor.execute(statement, parameters)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py&quot;, line 174, in execute</span>
<span class="go">    self.errorhandler(self, exc, value)</span>
<span class="go">  File &quot;/usr/lib/python2.7/dist-packages/MySQLdb/connections.py&quot;, line 36, in defaulterrorhandler</span>
<span class="go">    raise errorclass, errorvalue</span>
<span class="go">sqlalchemy.exc.OperationalError: (OperationalError) (1005, &quot;Can&#39;t create table &#39;neutron.ml2_network_segments&#39; (errno: 150)&quot;) &#39;\nCREATE TABLE ml2_network_segments (\n\tid VARCHAR(36) NOT NULL, \n\tnetwork_id VARCHAR(36) NOT NULL, \n\tnetwork_type VARCHAR(32) NOT NULL, \n\tphysical_network VARCHAR(64), \n\tsegmentation_id INTEGER, \n\tPRIMARY KEY (id), \n\tFOREIGN KEY(network_id) REFERENCES networks (id) ON DELETE CASCADE\n)\n\n&#39; ()</span>
</pre></div>


<p>原因是 Mysql 有对外键约束[1]，仔细查数据里发现 networks 表的 collcation 和新建上述表时的默认数据库 collcation 不一样。以下是Mysql对外键约束的描述[1]，我遇到的是第二条错误(加粗的部分)。</p>
<ul>
<li>Foreign key relationships involve a parent table that holds the central data values, and a child table with identical values pointing back to its parent. The FOREIGN KEY clause is specified in the child table. The parent and child tables must use the same storage engine. They must not be TEMPORARY tables.</li>
<li><strong>Corresponding columns in the foreign key and the referenced key must have similar data types. The size and sign of integer types must be the same. The length of string types need not be the same. For nonbinary (character) string columns, the character set and collation must be the same.</strong></li>
<li>MySQL requires indexes on foreign keys and referenced keys so that*  foreign key checks can be fast and not require a table scan. In the referencing table, there must be an index where the foreign key columns are listed as the first columns in the same order. Such an index is created on the referencing table automatically if it does not exist. This index might be silently dropped later, if you create another index that can be used to enforce the foreign key constraint. index_name, if given, is used as described previously.</li>
<li>InnoDB permits a foreign key to reference any index column or group of columns. However, in the referenced table, there must be an index where the referenced columns are listed as the first columns in the same order.</li>
<li>Index prefixes on foreign key columns are not supported. One consequence of this is that BLOB and TEXT columns cannot be included in a foreign key because indexes on those columns must always include a prefix length.</li>
<li>If the CONSTRAINT symbol clause is given, the symbol value, if used, must be unique in the database. A duplicate symbol will result in an error similar to: ERROR 1005 (HY000): Can't create table 'test.#sql-211d_3' (errno: 121). If the clause is not given, or a symbol is not included following the CONSTRAINT keyword, a name for the constraint is created automatically.</li>
<li>InnoDB does not currently support foreign keys for tables with user-defined partitioning. This includes both parent and child tables.</li>
</ul>
<p><strong>解决方法是</strong>：将 database 及 table 的 character 和 collcation 改成一样的就行了。</p>
<div class="highlight"><pre><span></span><span class="k">alter</span> <span class="k">database</span> <span class="n">neutron</span> <span class="k">DEFAULT</span> <span class="k">character</span> <span class="kt">set</span> <span class="n">utf8</span><span class="p">;</span>
</pre></div>


<h1 id="ref"><a class="toclink" href="#ref">REF</a><a class="headerlink" href="#ref" title="Permanent link">&para;</a></h1>
<ol>
<li><a href="https://bugs.launchpad.net/neutron/+bug/1332564" target="_blank">https://bugs.launchpad.net/neutron/+bug/1332564</a></li>
<li><a href="http://dev.mysql.com/doc/refman/5.1/en/create-table-foreign-keys.html" target="_blank">http://dev.mysql.com/doc/refman/5.1/en/create-table-foreign-keys.html</a></li>
</ol>
    <div class="copyright">
      <p><span>原始链接:</span><a href="http://xcodest.me/mysql-errno-150.html" target="_blank">http://xcodest.me/mysql-errno-150.html </a></p>
      <p> <span>许可协议:</span><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
    </div>
  </div><!-- /.entry-content -->
  <div>
    <nav>
      <ul class="pager">
        <li class="previous"><a href="pip-install-from-local.html">&larr; Older</a></li>
        <li class="next"><a href="ecitic9.html">Newer &rarr;</a></li>
      </ul>
    </nav>
  </div>
    <div class="comments">
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'xcodest';
        var disqus_identifier = 'mysql-errno-150.html';
        var disqus_url = 'http://xcodest.me/mysql-errno-150.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//xcodest.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
</section>
</div>
</div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12 text-center footer">
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41808584-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257099267'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1257099267' type='text/javascript'%3E%3C/script%3E"));</script>
        </div>
    </div>
</body>
</html>