<!DOCTYPE html>
<html lang="cn">
<head>
          <title>Xcodest</title>
        <meta charset="utf-8" />
        <link href="http://xcodest.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Xcodest Full Atom Feed" />
        <link href="http://xcodest.me/feeds/others.atom.xml" type="application/atom+xml" rel="alternate" title="Xcodest Categories Atom Feed" />



    <meta name="tags" contents="MySQL" />

        <link rel="stylesheet" href="http://xcodest.me/theme/css/main.css" type="text/css" charset="utf-8">
        <link rel="icon" type="image/png" href="http://xcodest.me/theme/img/favicon.ico">
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <span class='site-title'><a href="http://xcodest.me/">Xcodest</a></span><span class="site-subtitle">code for fun</span>
        </header>
<section id="content" class="body">
  <header>
    <h2 class="entry-title">MySQL Errno 150</h2>
    <span class="post-date"> Wed 14 January 2015 </span>
  </header>
  <div class="entry-content">
    <p>做OpenStack icehouse 升级到 Juno过程中，升级Neutron数据库时遇到这个错误。</p>
<div class="highlight"><pre><span class="err">$</span> <span class="nx">python</span> <span class="na">-m</span> <span class="nx">neutron.db.migration.migrate_to_ml2</span> <span class="nx">openvswitch</span> <span class="nx">mysql</span><span class="p">:</span><span class="c1">//USER:PASSWORD@10.251.1.8/neutron</span>
<span class="nx">Traceback</span> <span class="p">(</span><span class="nx">most</span> <span class="nx">recent</span> <span class="nb">call</span> <span class="nb">last</span><span class="p">):</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/runpy.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">162</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_run_module_as_main</span>
    <span class="s2">&quot;__main__&quot;</span><span class="p">,</span> <span class="nx">fname</span><span class="p">,</span> <span class="nx">loader</span><span class="p">,</span> <span class="nx">pkg_name</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/runpy.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">72</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_run_code</span>
    <span class="nx">exec</span> <span class="n">code</span> <span class="k">in</span> <span class="nx">run_globals</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/neutron/db/migration/migrate_to_ml2.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">462</span><span class="p">,</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span>
    <span class="nx">main</span><span class="p">()</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/neutron/db/migration/migrate_to_ml2.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">458</span><span class="p">,</span> <span class="k">in</span> <span class="nx">main</span>
    <span class="nx">args.vxlan_udp_port</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/neutron/db/migration/migrate_to_ml2.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">138</span><span class="p">,</span> <span class="k">in</span> <span class="nx">__call__</span>
    <span class="nx">metadata.create_all</span><span class="p">(</span><span class="nx">engine</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/schema.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">2848</span><span class="p">,</span> <span class="k">in</span> <span class="nx">create_all</span>
    <span class="n">tables</span><span class="o">=</span><span class="nb">tables</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">1479</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_run_visitor</span>
    <span class="nx">conn._run_visitor</span><span class="p">(</span><span class="nx">visitorcallable</span><span class="p">,</span> <span class="nb">element</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">1122</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_run_visitor</span>
    <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="bp">.</span><span class="nx">traverse_single</span><span class="p">(</span><span class="nb">element</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/sql/visitors.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">122</span><span class="p">,</span> <span class="k">in</span> <span class="nx">traverse_single</span>
    <span class="k">return</span> <span class="nx">meth</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kw</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/ddl.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">70</span><span class="p">,</span> <span class="k">in</span> <span class="nx">visit_metadata</span>
    <span class="bp">self.</span><span class="nx">traverse_single</span><span class="p">(</span><span class="nb">table</span><span class="p">,</span> <span class="n">create_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/sql/visitors.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">122</span><span class="p">,</span> <span class="k">in</span> <span class="nx">traverse_single</span>
    <span class="k">return</span> <span class="nx">meth</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kw</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/ddl.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">89</span><span class="p">,</span> <span class="k">in</span> <span class="nx">visit_table</span>
    <span class="bp">self.</span><span class="nx">connection.execute</span><span class="p">(</span><span class="nx">schema.CreateTable</span><span class="p">(</span><span class="nb">table</span><span class="p">))</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">662</span><span class="p">,</span> <span class="k">in</span> <span class="nb">execute</span>
    <span class="k">params</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">720</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_execute_ddl</span>
    <span class="nx">compiled</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">874</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_execute_context</span>
    <span class="nx">context</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">1024</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_handle_dbapi_exception</span>
    <span class="nx">exc_info</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/util/compat.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">196</span><span class="p">,</span> <span class="k">in</span> <span class="nx">raise_from_cause</span>
    <span class="nx">reraise</span><span class="p">(</span><span class="k">type</span><span class="p">(</span><span class="nx">exception</span><span class="p">),</span> <span class="nx">exception</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="nx">exc_tb</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/base.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">867</span><span class="p">,</span> <span class="k">in</span> <span class="nx">_execute_context</span>
    <span class="nx">context</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/sqlalchemy/engine/default.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">324</span><span class="p">,</span> <span class="k">in</span> <span class="nx">do_execute</span>
    <span class="nx">cursor.execute</span><span class="p">(</span><span class="nb">statement</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/MySQLdb/cursors.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">174</span><span class="p">,</span> <span class="k">in</span> <span class="nb">execute</span>
    <span class="bp">self.</span><span class="nx">errorhandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nx">exc</span><span class="p">,</span> <span class="nb">value</span><span class="p">)</span>
  <span class="nb">File</span> <span class="s2">&quot;/usr/lib/python2.7/dist-packages/MySQLdb/connections.py&quot;</span><span class="p">,</span> <span class="nb">line</span> <span class="mi">36</span><span class="p">,</span> <span class="k">in</span> <span class="nx">defaulterrorhandler</span>
    <span class="nx">raise</span> <span class="nx">errorclass</span><span class="p">,</span> <span class="nx">errorvalue</span>
<span class="nx">sqlalchemy.exc.OperationalError</span><span class="p">:</span> <span class="p">(</span><span class="nx">OperationalError</span><span class="p">)</span> <span class="p">(</span><span class="mi">1005</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t create table &#39;neutron.ml2_network_segments&#39; (errno: 150)&quot;</span><span class="p">)</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">CREATE TABLE ml2_network_segments (</span><span class="se">\n\t</span><span class="s1">id VARCHAR(36) NOT NULL, </span><span class="se">\n\t</span><span class="s1">network_id VARCHAR(36) NOT NULL, </span><span class="se">\n\t</span><span class="s1">network_type VARCHAR(32) NOT NULL, </span><span class="se">\n\t</span><span class="s1">physical_network VARCHAR(64), </span><span class="se">\n\t</span><span class="s1">segmentation_id INTEGER, </span><span class="se">\n\t</span><span class="s1">PRIMARY KEY (id), </span><span class="se">\n\t</span><span class="s1">FOREIGN KEY(network_id) REFERENCES networks (id) ON DELETE CASCADE</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="p">()</span>
</pre></div>


<p>原因是 Mysql 有对外键约束[1]，仔细查数据里发现 networks 表的 collcation 和新建上述表时的默认数据库 collcation 不一样。以下是Mysql对外键约束的描述[1]，我遇到的是第二条错误(加粗的部分)。</p>
<blockquote>
<ul>
<li>Foreign key relationships involve a parent table that holds the central data values, and a child table with identical values pointing back to its parent. The FOREIGN KEY clause is specified in the child table. The parent and child tables must use the same storage engine. They must not be TEMPORARY tables.</li>
<li>Corresponding columns in the foreign key and the referenced key must have similar data types. The size and sign of integer types must be the same. The length of string types need not be the same. For nonbinary (character) string columns, the character set and collation must be the same.</li>
<li>MySQL requires indexes on foreign keys and referenced keys so that*  foreign key checks can be fast and not require a table scan. In the referencing table, there must be an index where the foreign key columns are listed as the first columns in the same order. Such an index is created on the referencing table automatically if it does not exist. This index might be silently dropped later, if you create another index that can be used to enforce the foreign key constraint. index_name, if given, is used as described previously.</li>
<li>InnoDB permits a foreign key to reference any index column or group of columns. However, in the referenced table, there must be an index where the referenced columns are listed as the first columns in the same order.</li>
<li>Index prefixes on foreign key columns are not supported. One consequence of this is that BLOB and TEXT columns cannot be included in a foreign key because indexes on those columns must always include a prefix length.</li>
<li>If the CONSTRAINT symbol clause is given, the symbol value, if used, must be unique in the database. A duplicate symbol will result in an error similar to: ERROR 1005 (HY000): Can't create table 'test.#sql-211d_3' (errno: 121). If the clause is not given, or a symbol is not included following the CONSTRAINT keyword, a name for the constraint is created automatically.</li>
<li>InnoDB does not currently support foreign keys for tables with user-defined partitioning. This includes both parent and child tables.</li>
</ul>
</blockquote>
<p><strong>解决方法是</strong>：将 database 及 table 的 character 和 collcation 改成一样的就行了。</p>
<div class="highlight"><pre><span class="k">alter</span> <span class="k">database</span> <span class="n">neutron</span> <span class="k">DEFAULT</span> <span class="k">character</span> <span class="kt">set</span> <span class="n">utf8</span><span class="p">;</span>
</pre></div>


<h1>REF</h1>
<ol>
<li><a href="https://bugs.launchpad.net/neutron/+bug/1332564">https://bugs.launchpad.net/neutron/+bug/1332564</a></li>
<li><a href="http://dev.mysql.com/doc/refman/5.1/en/create-table-foreign-keys.html">http://dev.mysql.com/doc/refman/5.1/en/create-table-foreign-keys.html</a></li>
</ol>
  </div><!-- /.entry-content -->
  <div class="entry-info">
    <p> Tags: <a href="http://xcodest.me/tag/mysql.html">MySQL</a>  </p>
  </div>
    <div class="comments">
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'xcodest';
        var disqus_identifier = 'mysql-errno-150.html';
        var disqus_url = 'http://xcodest.me/mysql-errno-150.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//xcodest.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
</section>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41808584-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>