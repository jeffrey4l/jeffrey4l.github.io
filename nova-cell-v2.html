<!DOCTYPE html>
<html lang="cn">
<head>
      <title> Nova Cell V2 详解 -   - Xcodest</title>
    <meta charset="utf-8" />



    <meta name="tags" contents="OpenStack" />
    <meta name="tags" contents="Kolla" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://xcodest.me/theme/css/bootstrap.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="http://xcodest.me/theme/css/bootstrap-theme.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="http://xcodest.me/theme/css/pygment.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="http://xcodest.me/theme/css/main.css" type="text/css" charset="utf-8">
    <script src="http://xcodest.me/theme/js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://xcodest.me/theme/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://xcodest.me/theme/js/xcodest.js" type="text/javascript" charset="utf-8"></script>
    <link rel="icon" type="image/png" href="http://xcodest.me/theme/img/favicon.ico">
    <link href="http://xcodest.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Xcodest RSS Feed" />
</head>

<body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12">
          <div class="navbar navbar-default">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="offcanvas" data-target="#sidebar">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://xcodest.me">
                  Xcodest
                </a>
              </div>
              <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                  <li><a href="/archives.html">Archives</a></li>
                  <li><a href="/tags.html">Tags</a></li>
                  <li>
                    <a href="http://xcodest.me/pages/about.html">About</a>
                  </li>
                </ul>
                <form class="navbar-form navbar-right" action="https://google.com/search" target="_blank">
                  <div class="input-group">
                    <input name="q" type="text" class="form-control" required placeholder="Search Xcodest.com..."/>
                    <input type="hidden" name="sitesearch" value="xcodest.me"/>
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit">
                        <i class="glyphicon glyphicon-search"></i>
                      </button>
                    </span>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-offset-1 col-md-2 col-xs-12 hidden-xs hidden-sm" id="sidebar">
          <div class="panel panel-default">
            <div class="panel-heading">Categories</div>
            <div class="list-group">
              <a class="list-group-item" href="http://xcodest.me/category/life.html">Life</a>
              <a class="list-group-item" href="http://xcodest.me/category/linux.html">Linux</a>
              <a class="list-group-item" href="http://xcodest.me/category/openstack.html">OpenStack</a>
              <a class="list-group-item" href="http://xcodest.me/category/others.html">Others</a>
              <a class="list-group-item" href="http://xcodest.me/category/programming.html">Programming</a>
              <a class="list-group-item" href="http://xcodest.me/category/python.html">Python</a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Social</div>
            <div class="list-group">
 
              <a class="list-group-item" href="http://github.com/jeffrey4l" target="_blank">Github</a>
 
              <a class="list-group-item" href="https://twitter.com/Jeffrey4l" target="_blank">Twitter</a>
 
              <a class="list-group-item" href="http://weibo.com/jeffrey4l" target="_blank">微博</a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Blogroll</div>
            <div class="list-group">
              <a class="list-group-item" href="http://99cloud.net" target="_blank">99cloud(九州云)</a>
              <a class="list-group-item" href="http://chenshake.com/" target="_blank">陈沙克日志</a>
              <a class="list-group-item" href="http://coolshell.cn" target="_blank">酷壳 - CoolShell.Cn</a>
              <a class="list-group-item" href="https://sdake.io/" target="_blank">Steven Dake</a>
              <a class="list-group-item" href="https://sebastien-han.fr/" target="_blank">SÉBASTIEN HAN</a>
              <a class="list-group-item" href="http://blog.csdn.net/quqi99" target="_blank">技术并艺术着</a>
            </div>
          </div>
        </div>
        <div class="col-md-8 col-xs-12">
<div class="row">
  <div class="col-md-12 col-xs-12">
  <section id="content" class="body">
  <header>
    <h2 class="entry-title">Nova Cell V2 详解</h2>
    <span class="post-date"> 2017-02-23 </span>
  </header>
  <div class="entry-content">
    <p> 现在 ，OpenStack  在控制平面上的性能瓶颈主要在  Message Queue  和  Database 。 尤其是  Message Queue ,  随着计算节点的增加 ， 性能变的越来越差 。 为了应对这种情况 ， Nova  很早之前提出来  nova-cell ( 以下以  cellv1  代替 )   的解决方案 。 目的是在把大的  OpenStack  集群分成小的单元 ， 每个单元有自己的  Message Queue  和  Database。 以此来解决规模增加时引起的性能问题 。 而且不会向  Region  那样 ， 把各个集群独立运行 。 在  cell  里面 ，Keystone、Neutron、Cinder、Glance  等资源还是共享的 。</p>
<div class="section" id="cell-v1">
<h2>cell v1</h2>
<p>cellv1  最初的想法很好 ， 但是局限于早期  nova  的架构 ， 硬生生的加个  nova-cell  服务来在各个  cell  间传递消息 ， 使得架构更加复杂 。 以下是  cellv1  的架构 </p>
<img alt="nova cell v1 architecture" class="align-center" src="images/nova-cell/nova-cell-v1-arch.jpg" style="width: 371px; height: 374px;" />
<p>cell v1  的问题在于 ：</p>
<ul class="simple">
<li> 一直以来 ，cell v1  被标记为实验性质 </li>
<li> 相关的测试很少 ， 而且也没有  v1 + neutron  的测试 </li>
<li> 现在来说功能已经冻结 ， 不会加入新的功能 </li>
<li> 不严重的  Bug  根本不会去修复 </li>
<li> 使用案例很少 。 现在经常提到的使用案例也只有 CERN（ 欧洲原子能研究中心 ）。 一般规模下 ， 完全没有必要搭建  cell v1</li>
</ul>
<p> 所以 ， 现在进行部署的话 ， 如果用  cell,  就尽量使用  cell v2  吧 。</p>
</div>
<div class="section" id="cell-v2">
<h2>cell v2</h2>
<p>cell v2  自  Newton  版本引入 ，Ocata  版本变为必要组件 。 以后默认部署都会初始化一个单  cell  的架构 。</p>
<p>cell v2  的架构图如下 ， 看着比  cell v1  清爽不少 。</p>
<img alt="nova cell v2 architecture" class="align-center" src="images/nova-cell/nova-cell-v2-arch.jpg" style="width: 554px; height: 319px;" />
<p> 从架构图上 ， 可以看到 ：</p>
<ul class="simple">
<li>api  和  cell  有了明显的边界 。 api  层面只需要数据库 ， 不需要  Message Queue。<ul>
<li>nova-api  现在依赖  nova_api  和  nova_cell0  两个数据库 。</li>
</ul>
</li>
<li>nova-scheduler  服务只需要在  api  层面上安装 ，cell  不需要参数调度 。 这样实现了一次调度就可以确定到具体在哪个  cell  的哪台机器上启动 <ul>
<li> 这里其实依赖  placement  服务 ,  以后的文章会提到 </li>
</ul>
</li>
<li>cell  里面只需要安装  nova-compute  和  nova-conductor  服务 ， 和其依赖的  DB  和  MQ</li>
<li> 所有的  cell  变成一个扁平架构 。 比之前的多层父子架构要简化很多 。</li>
<li>api 上面服务会直接连接  cell  的  MQ  和  DB,  所以不需要类似  nova-cell  这样子的额外服务存在 。 性能上也会有及大的提升 </li>
</ul>
<div class="section" id="nova-api-nova-cell0">
<h3>nova_api &amp; nova_cell0</h3>
<p> 自  Newton  版本 ，nova  就一直拆分  nova  数据库 ，  为  cell v2  做准备 。  把一些全局数据表从  nova  库搬到了  nova_api,  下面是现在  nova_api  里面的所有表 。</p>
<pre class="literal-block">
+------------------------------+     +------------------------------+
| Tables_in_nova_api           |     | Tables_in_nova_api           |
+------------------------------+     +------------------------------+
| aggregate_hosts              |     | inventories                  |
| aggregate_metadata           |     | key_pairs                    |
| aggregates                   |     | migrate_version              |
| allocations                  |     | placement_aggregates         |
| build_requests               |     | project_user_quotas          |
| cell_mappings                |     | quota_classes                |
| flavor_extra_specs           |     | quota_usages                 |
| flavor_projects              |     | quotas                       |
| flavors                      |     | request_specs                |
| host_mappings                |     | reservations                 |
| instance_group_member        |     | resource_classes             |
| instance_group_policy        |     | resource_provider_aggregates |
| instance_groups              |     | resource_providers           |
| instance_mappings            |     |                              |
+------------------------------+     +------------------------------+
</pre>
<p> 可以看到像  flavor, instance groups, quota  这些表已经迁移了过来 。</p>
<p>nova_cell0  数据库的  schema  和  nova  是一样的 ， 他存在的只要用途是 ： 当  instance  调度失败时 ， instance  的信息不属于任何一个  cell,  所以放到  cell0  上面 。 因此里面的数据并不是太重要 。</p>
</div>
<div class="section" id="cell-related-tables">
<h3>Cell Related Tables</h3>
<p>Cell  相关的数据库表都在  nova_api  里面 ， 包括  cell_mappings, host_mappings, instance_mappings。 其表结构如下 ：</p>
<img alt="" class="align-center" src="images/nova-cell/nova-cell-v2-uml.jpg" style="width: 391px; height: 204px;" />
<ul class="simple">
<li>cell_mappings  表  cell  的  Database  和  Mesage Queue  的连接 。 用于和子  cell  通讯 </li>
<li>host_mappings  是用于  nova-scheduler,  可以确认分配到的机器 。 这里其实也有一个坑 ， 之前  nova-compute  启动起来 ， 就可以直接使用了 ，cell v2  之后 ， 就需要手动运行  <tt class="docutils literal"><span class="pre">nova-manage</span> cell_v2 discover_host</tt> ,  把  host mapping  到  cell_mappings  表里面 ， 那台计算节点才会加入到调度中 。</li>
<li>instance_mappings  表里有所有  instance id,  这样在查询  instance  时 ， 就可以从这个表里查到他所在的  cell,  然后直连  cell  拿到  instance  具体信息 。</li>
</ul>
</div>
<div class="section" id="cell">
<h3>cell  流程 </h3>
<pre class="literal-block">
                        api/cell boundary
                                +
 nova show &lt;uuid&gt;               |
             |                  |
             v      3           |
        nova-api+--------------------&gt;cell-db
         +     +                |
         |     +----+           |
        1|          | 2         |      1. Determine which cell the instance is in
         v          v           |      2. Get db connection for cell
instance_mapping  cell_mapping  |      3. Query cell db for data
                                +
</pre>
<p> 当想要获取一个机器的详细信息时 :</p>
<ol class="arabic simple">
<li>nova-api  先从  instance_mappings  表拿到  instance  的  cell_id</li>
<li> 再从  cell_mappings  表拿到所在  cell  的  DB connection</li>
<li> 直接连接  cell   的  DB  拿到机器的详细信息 </li>
</ol>
<pre class="literal-block">
                        api/cell boundary
                                +
 nova reboot &lt;uuid&gt;             |
              +                 |
              |                 |
              v    3            |
        nova-api+--------------------&gt;cell-mq+-----&gt;compute
         +     +                |
         |     +---+            |
        1|         | 2          |      1. Determine which cell the instance is in
         v         v            |      2. Get mq connection for cell
instance_mapping cell_mapping   |      3. Send RPC message to compute
                                +
</pre>
<p> 当要重启一台机器时 ：</p>
<ol class="arabic simple">
<li>nova-api  先从  instance_mappings  表里拿到  instance  所在的  cell_id</li>
<li> 从  cell_mappings  里拿到所在  cell  的  message queue  连接 </li>
<li>nova-api  直接给  mq  的相关队列发重启机器的消息 </li>
</ol>
<pre class="literal-block">
                        api/cell boundary
                                +
 nova boot  ...                 |
         +        3             |
         |    +----------------------&gt;cell-db
         v    +   4             |
        nova-api+--------------------&gt;cell-mq+-&gt;conductor+-&gt;compute
         +    +                 |
         |    +-------------+   |
        2|     1            |   |
         v                  |   |       1. Schedule the instance
instance_mapping            |   |       2. Record which cell the instance was scheduled to
                            |   +       3. Create instance record
                            v           4. Send RPC message to conductor to build
                       scheduling
</pre>
<p> 当新建机器时 :</p>
<ol class="arabic simple">
<li>nova-api  接到用户的请求信息 ， 先转发到  nova-scheduler  进行调度 ，
nova-scheduler  通过  placement service,  直接确定分配到哪台机器上 </li>
<li>nova-api  把  instance  的信息存入 instance_mappings  表 </li>
<li>nova-api  把机器信息存到目标  cell  的  database</li>
<li>nova-api  给  cell  的  message queue  的相关队列发消息 ， 启动机器 </li>
</ol>
</div>
<div class="section" id="id1">
<h3>Cell v2  的优点 </h3>
<ul class="simple">
<li> 数据库和消息队列作为  nova  的一等公民 。</li>
<li> 在  cell  的数据库里没有冗余数据 ， 所有共享数据都在  nova-api  中 </li>
<li> 全局数据和  cell  数据有一条清晰的界线 </li>
<li> 非  cell  用户很容易的就可以迁移到  cell v2  上面 。 不需要更改现在的部署架构 </li>
<li>cell v1  的用户也可以迁移到  cell v2  上 。 只要手动建立起所有的 mapping,  关掉现在存在的  nova-cell  服务 ， 清掉最上层  cell  的数据库 。 但是最上层  cell  本质上和其它  cell  是不同的 。  所以需要调整架构 </li>
<li> 增减  cell  变的十分简单 ， 而且在把某个 cell  加入之前 ， 可以在其它环境进行测试 </li>
</ul>
</div>
<div class="section" id="id2">
<h3>Cell v2  相关命令 </h3>
<p> 因为  cell v2  完全靠  database  的操作为建立 ， 所以也没有相关的  api  接口 。  主要靠  nova-manage cell_v2  命令 。 详细说明参见  <a class="footnote-reference" href="#id7" id="id3">[1]</a></p>
<pre class="literal-block">
nova-manage cell_v2

    create_cell
    delete_cell
    list_cells

    map_cell0
    discover_hosts
    simple_cell_setup

    map_cell_and_hosts
    map_instances
    verify_instance
</pre>
</div>
<div class="section" id="id4">
<h3> 其它 </h3>
<div class="section" id="id5">
<h4> 计算节点自动发现 </h4>
<p> 上面提到了现在  nova-compute  服务上线后 ， 不会自动加到  nova-api  的  host_mappings  里面 ， 也就不会加到  nova-scheduler  的调度中 。  需要手动运行  <tt class="docutils literal"><span class="pre">nova-manage</span> cell_v2 discover_hosts</tt>  命令 。 这显示略显繁琐 。</p>
<p> 在小型一些的环境上 ， 推荐打开自动发现功能 ， 就不用手动跑命令了 。</p>
<pre class="literal-block">
[scheduler]
discover_hosts_in_cells_interval=-1

#This value controls how often (in seconds) the scheduler should attempt
#to discover new hosts that have been added to cells. If negative (the
#default), no automatic discovery will occur.
</pre>
</div>
<div class="section" id="id6">
<h4> 性能分析 </h4>
<p> 为了拿到  instance  的详细信息 ， 需要查询  nova_api  数据库 ， 相比之前要多查询一次数据库 (  虽然是有三个表 ， 但是可以用多表连接查询 ， 一次就可以拿到所有的结果  )。 但是一来数据相当少 ， 而且很容易加上一层  cache,  并不会对性造成什么影响 。</p>
</div>
</div>
<div class="section" id="kolla">
<h3>Kolla  实现 </h3>
<p> 现在  Kolla  已经支持自动部署一个基本的  cell  环境 ， 而且支持从没有  cell  的  Newton  升级到有  cell  的  Ocata  版本 。</p>
</div>
</div>
<div class="section" id="ref">
<h2>REF</h2>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td><a class="reference external" href="https://docs.openstack.org/developer/nova/man/nova-manage.html#nova-cells-v2">https://docs.openstack.org/developer/nova/man/nova-manage.html#nova-cells-v2</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><a class="reference external" href="https://www.openstack.org/videos/video/nova-cells-v2-whats-going-on">Presentation that Andrew Laski gave at the Austin (Newton) summit</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><a class="reference external" href="https://docs.openstack.org/developer/nova/cells.html">https://docs.openstack.org/developer/nova/cells.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><a class="reference external" href="http://paste.openstack.org/show/144068/">Flow chart</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><a class="reference external" href="https://wiki.openstack.org/wiki/Nova-Cells-v2">https://wiki.openstack.org/wiki/Nova-Cells-v2</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td><a class="reference external" href="https://www.ustack.com/news/what-is-nova-cells-v2/">https://www.ustack.com/news/what-is-nova-cells-v2/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[7]</td><td><a class="reference external" href="http://www.cnblogs.com/wanglm/articles/5749813.html">http://www.cnblogs.com/wanglm/articles/5749813.html</a></td></tr>
</tbody>
</table>
</div>

  </div><!-- /.entry-content -->
  <div>
    <nav>
      <ul class="pager">
        <li class="previous"><a href="ansible-with-items-auto-flatten-list-of-lists.html">&larr; Older</a></li>
        <li class="next disabled"><a href="#">Newer &rarr;</a></li>
      </ul>
    </nav>
  </div>
  <div class="entry-info">
    <p> Tags: <a href="http://xcodest.me/tag/openstack.html">OpenStack</a> <a href="http://xcodest.me/tag/kolla.html">Kolla</a>  </p>
  </div>
    <div class="comments">
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'xcodest';
        var disqus_identifier = 'nova-cell-v2.html';
        var disqus_url = 'http://xcodest.me/nova-cell-v2.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//xcodest.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
</section>
</div>
</div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12 text-center footer">
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41808584-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257099267'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1257099267' type='text/javascript'%3E%3C/script%3E"));</script>
        </div>
    </div>
</body>
</html>