<!DOCTYPE html>
<html lang="cn">
<head>
      <title> 使用 Ansible 管理 Kubernetes 资源 - 代码杂货铺</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/bootstrap.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/bootstrap-theme.min.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/pygment.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="https://xcodest.me/theme/css/main.css" type="text/css" charset="utf-8">
    <script src="https://xcodest.me/theme/js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://xcodest.me/theme/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://xcodest.me/theme/js/xcodest.js" type="text/javascript" charset="utf-8"></script>
    <link rel="icon" type="image/png" href="https://xcodest.me/theme/img/favicon.ico">
    <link href="https://xcodest.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="代码杂货铺 RSS Feed" />
</head>

<body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12">
          <div class="navbar navbar-default">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="offcanvas" data-target="#sidebar">
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://xcodest.me">
                  代码杂货铺
                </a>
              </div>
              <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                  <li><a href="/archives.html">Archives</a></li>
                  <li><a href="/tags.html">Tags</a></li>
                  <li>
                    <a href="https://xcodest.me/pages/about.html">About</a>
                  </li>
                  <li>
                    <a href="https://xcodest.me/pages/opensource-books.html">Opensource books</a>
                  </li>
                </ul>
                <form class="navbar-form navbar-right" action="https://google.com/search" target="_blank">
                  <div class="input-group">
                    <input name="q" type="text" class="form-control" required placeholder="Search Xcodest.com..."/>
                    <input type="hidden" name="sitesearch" value="xcodest.me"/>
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit">
                        <i class="glyphicon glyphicon-search"></i>
                      </button>
                    </span>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-offset-1 col-md-2 col-xs-12 hidden-xs hidden-sm" id="sidebar">
          <div class="panel panel-default">
            <div class="panel-heading">欢迎订阅我的公众号</div>
            <div class="list-group">
               <img class="qrcode" src="https://xcodest.me/images/qrcode.jpg"/>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Social</div>
            <div class="list-group">
 
              <a class="list-group-item" href="http://github.com/jeffrey4l" target="_blank">Github</a>
 
              <a class="list-group-item" href="https://twitter.com/Jeffrey4l" target="_blank">Twitter</a>
 
              <a class="list-group-item" href="http://weibo.com/jeffrey4l" target="_blank">微博</a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Categories</div>
            <div class="list-group">
              <a class="list-group-item" href="https://xcodest.me/category/ceph.html">Ceph<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/cloud.html">Cloud<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/container.html">Container<span class="badge">2</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/database.html">Database<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/life.html">Life<span class="badge">3</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/linux.html">Linux<span class="badge">18</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/openstack.html">OpenStack<span class="badge">20</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/ops.html">Ops<span class="badge">1</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/others.html">Others<span class="badge">5</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/programming.html">Programming<span class="badge">5</span></a>
              <a class="list-group-item" href="https://xcodest.me/category/python.html">Python<span class="badge">2</span></a>
            </div>
          </div>
          <div class="panel panel-default">
            <div class="panel-heading">Blogroll</div>
            <div class="list-group">
              <a class="list-group-item" href="http://99cloud.net" target="_blank">99cloud(九州云)</a>
              <a class="list-group-item" href="http://chenshake.com/" target="_blank">陈沙克日志</a>
              <a class="list-group-item" href="http://coolshell.cn" target="_blank">酷壳 - CoolShell.Cn</a>
              <a class="list-group-item" href="https://sdake.io/" target="_blank">Steven Dake</a>
              <a class="list-group-item" href="https://sebastien-han.fr/" target="_blank">SÉBASTIEN HAN</a>
              <a class="list-group-item" href="http://blog.csdn.net/quqi99" target="_blank">技术并艺术着</a>
            </div>
          </div>
        </div>
        <div class="col-md-8 col-xs-12">
<div class="row">
  <div class="col-md-12 col-xs-12">
  <section id="content" class="body">
  <header>
    <h1 class="entry-title">使用 Ansible 管理 Kubernetes 资源</h1>
    <div class="entry-info">
      <span class="glyphicon glyphicon-list-alt"></span>
      <span class="post-date"> 2018-10-22 </span>
      <!--
      <a class="post-category label label-default" href="https://xcodest.me/category/others.html">Others</a>
      -->
      <span class="glyphicon glyphicon-tags"></span>
    </div>
  </header>
  <div class="entry-content">
    <p>前两天，一篇<a href="https://medium.com/virtuslab/think-twice-before-using-helm-25fbb18bc822" target="_blank">「Think twice before using Helm」</a>(译文:<a href="https://mp.weixin.qq.com/s/5iG9kZl7Qp5l3_BCXajrSA" target="_blank">「恕我直言，对Helm大家还是要三思而后用」</a>) 引起了大家的关注。作者从认证，生命周期管理，错误处理等多个角度说明了 Helm 自身的问题。我基本赞同作者的观点。多数情况下我们只是把 helm 当做一个模板引擎在使用，把 charts 生成 Kubernetes 可以处理的格式。但是从使用角度来说，这个模板实现的太重了。有兴趣的可以去读读原文。</p>
<p>那如果 Helm 不轻量好用的话，我们有啥其他选择?</p>
<p>Ansible 做为部署管理的工具，正在受到越来越多的运维人员的追捧。他支持 Jinja2 的模板引擎，而且是无代理节点的架构，很方便来做一些模板工作。所以本文来介绍使用 Ansible 如何管理 Kubernetes 上面的资源。</p>
<p>首先使用 Ansible 避免不了使用其模块。与 Kubernetes 相关的模块可以从[1]找到。现在主要有<code>k8s</code>, <code>k8s_facts</code>, <code>k8s_scale</code>, <code>kubernetes</code>和<code>oc</code> 5个模块。其中 <code>kubernetes</code> 和 <code>oc</code> 模块因为实现逻辑不好用，在 ansible 2.6 版本中已经废弃掉， 推荐使用前三个。其中，<code>k8s_scale</code> 来自 ansible 2.5, <code>k8s</code> 来自 ansible 2.6, <code>k8s_facts</code> 来自 ansible 2.7。使用这三个模块的话，还需要安装 <code>openshift</code> 的 Python 包。以下代码全部基于 ansible 2.7 版本。</p>
<h2 id="k8s"><a class="toclink" href="#k8s">k8s 模块</a><a class="headerlink" href="#k8s" title="Permanent link">&para;</a></h2>
<p>管理 kubernetes 各种资源的话，使用 <code>k8s</code> 模块就可以了，如下是创建 namespace 的写法</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Create a k8s namespace</span>
  <span class="nt">k8s</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testing</span>
    <span class="nt">api_version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
    <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Namespace</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
</pre></div>


<p>如果要创建一个 Service, 也可以使用如下面的写法。</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Create a Service object from an inline definition</span>
  <span class="nt">k8s</span><span class="p">:</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="nt">definition</span><span class="p">:</span>
      <span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
      <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
      <span class="nt">metadata</span><span class="p">:</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
        <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testing</span>
        <span class="nt">labels</span><span class="p">:</span>
          <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">galaxy</span>
          <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
      <span class="nt">spec</span><span class="p">:</span>
        <span class="nt">selector</span><span class="p">:</span>
          <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">galaxy</span>
          <span class="nt">service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
        <span class="nt">ports</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
            <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">port-8000-tcp</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
</pre></div>


<p>可以看到 <code>definition</code> 里面就是原生的 Kubernetes 里面的写法，而 <code>k8s</code> 模块的参数也写少，所以上手会很快。</p>
<p>如果 k8s 模块和 ansible <code>lookup</code> 插件合用的话，可以写出更加简洁的代码，如下</p>
<div class="highlight"><pre><span></span><span class="x"># tasks.yml</span>
<span class="x">- name: Create a Service object from an external file</span>
<span class="x">  var:</span>
<span class="x">    name: &quot;web&quot;</span>
<span class="x">  k8s:</span>
<span class="x">    state: present</span>
<span class="x">    definition: &quot;</span><span class="cp">{{</span> <span class="nv">lookup</span><span class="o">(</span><span class="s1">&#39;template&#39;</span><span class="o">,</span> <span class="s1">&#39;/path/to/service.yml&#39;</span><span class="o">)</span> <span class="o">|</span> <span class="nf">from_yaml</span> <span class="cp">}}</span><span class="x">&quot;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="x"># /path/to/service.yml</span>
<span class="x">---</span>
<span class="x">apiVersion: v1</span>
<span class="x">kind: Service</span>
<span class="x">metadata:</span>
<span class="x">  name: </span><span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="x">          # &lt;-- 这里可以使用变量</span>
<span class="x">namespace: testing</span>
<span class="x">labels:</span>
<span class="x">  app: galaxy</span>
<span class="x">  service: web</span>
<span class="x">spec:</span>
<span class="x">  selector:</span>
<span class="x">    app: galaxy</span>
<span class="x">    service: web</span>
<span class="x">ports:</span>
<span class="x">  - protocol: TCP</span>
<span class="x">    targetPort: 8000</span>
<span class="x">    name: port-8000-tcp</span>
<span class="x">    port: 8000</span>
</pre></div>


<p>可以看到 Kubernetes service 文件可以完全从 task 里面独立出来，独立后的写法就是原生的 kubernetes 的格式，基本就和 Charts 的结构差不多了。</p>
<p>基于此，完全可以使用这种方式替换掉 helm 的模板功能，而且没有引入任何额外的依赖，就是直接的 ansible 生成相关文件，丢给 kubernetes api 来处理。等部署完成后，我们也可以脱离 Ansible 继续通过 <code>kubelet</code> 命令维护这些资源。也正是由于这么简洁的实现，<code>k8s</code> 模块可以管理 Kubernetes 和 OpenShift, 也可以管理各种 <code>CRD</code> 资源。</p>
<p>相比于 helm ， 这种方法的缺点在于 YAML 文件都要自己写，没有社区在维护的 Charts。不像 helm 那样，一个命令就可以把服务都安装上。前期的工作还是挺多的。但是从另外一个角度来说，社区维护的 Charts 做一些 Demo 还可以，真要生产上面使用，还是要做大量工作的。所以从这个角度上讲，使用 Ansible 也没有带来太大的工作量。</p>
<p>我更期待社区可以使用 Ansible 直接管理 Charts 资源，或可以有一个工具把 Charts 的 Go 模板转成 Ansible 可以接受的 Jinja2 格式。</p>
<h2 id="k8s_scale-k8s_facts"><a class="toclink" href="#k8s_scale-k8s_facts">k8s_scale 和  k8s_facts 模块</a><a class="headerlink" href="#k8s_scale-k8s_facts" title="Permanent link">&para;</a></h2>
<p>这两个模块算辅助的功能，我觉得使用的机会可能并不会太多。<code>k8s_scale</code> 的例子如下</p>
<div class="highlight"><pre><span></span>- name: Scale deployment up, and extend timeout
  k8s_scale:
    api_version: v1
    kind: Deployment
    name: elastic
    namespace: myproject
    replicas: 3
    wait_timeout: 60

- name: Scale deployment down when current replicas match
  k8s_scale:
    api_version: v1
    kind: Deployment
    name: elastic
    namespace: myproject
    current_replicas: 3
    replicas: 2
</pre></div>


<p>它可以动态调整 Deployment 的 <code>replicas</code> 个数，基本上等同于<code>kubectl scale</code> 命令，但是这个功能基本可以使用 <code>k8s</code> 模块通过改变 <code>replicas</code> 参数来调整。</p>
<p><code>k8s_facts</code>的例子如下</p>
<div class="highlight"><pre><span></span>- name: Get an existing Service object
  k8s_facts:
    api_version: v1
    kind: Service
    name: web
    namespace: testing
  register: web_service
</pre></div>


<p>使用他，你可以检查某个资源是否存在，如果存在的话，还可以获得这个资源的yaml 文件描述，我觉得在 Ansible 流程控制中会有一些作用，可以根据当前 Kubernets 里面资源情况，有选择的做一些动作。</p>
<h2 id="_1"><a class="toclink" href="#_1">小技巧</a><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>因为 Ansible 是 Python 编写的，在使用 pip 安装时容易破坏系统已经安装的 Python 包，推荐使用虚拟环境来安装。</p>
<div class="highlight"><pre><span></span># mkvirtualenv --system-site-packages ansible
# pip install &#39;ansible&lt;2.7&#39; openshift
</pre></div>


<p>使用时，需要指定 Ansible 使用的 python interpreter 变量 </p>
<div class="highlight"><pre><span></span># workon ansible
# ansible-playbook -i localhost, -c local test.yml  -e ansible_python_interpreter=<span class="cp">${</span><span class="n">VIRTUAL_ENV</span><span class="cp">}</span>/bin/python
</pre></div>


<h2 id="demo"><a class="toclink" href="#demo">demo</a><a class="headerlink" href="#demo" title="Permanent link">&para;</a></h2>
<p>以下是使用 ansible 在 OpenShift 上面部署 echoserver 的一个完整例子</p>
<div class="highlight"><pre><span></span><span class="x">---</span>
<span class="x">- hosts: localhost</span>
<span class="x">  connection: local</span>
<span class="x">  gather_facts: false</span>
<span class="x">  vars:</span>
<span class="x">    namespace: demo</span>
<span class="x">  tasks:</span>
<span class="x">    - name: Create echo server deployment config</span>
<span class="x">      k8s:</span>
<span class="x">        namespace: &quot;</span><span class="cp">{{</span> <span class="nv">namespace</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        definition:</span>
<span class="x">          apiVersion: v1</span>
<span class="x">          kind: DeploymentConfig</span>
<span class="x">          metadata:</span>
<span class="x">            name: echoserver</span>
<span class="x">          spec:</span>
<span class="x">            replicas: 1</span>
<span class="x">            template:</span>
<span class="x">              metadata:</span>
<span class="x">                labels:</span>
<span class="x">                  app: echoserver</span>
<span class="x">              spec:</span>
<span class="x">                containers:</span>
<span class="x">                  - name: echoserver</span>
<span class="x">                    image: googlecontainer/echoserver:1.5</span>
<span class="x">                    readnessProbe:</span>
<span class="x">                      httpGet:</span>
<span class="x">                        port: 8080</span>
<span class="x">                        path: /</span>
<span class="x">                      initialDelaySeconds: 20</span>
<span class="x">                      periodSeconds: 5</span>
<span class="x">                    livenessProbe:</span>
<span class="x">                      httpGet:</span>
<span class="x">                        port: 8080</span>
<span class="x">                        path: /</span>
<span class="x">                      initialDelaySeconds: 10</span>
<span class="x">                      periodSeconds: 3</span>
<span class="x">    - name: Create echo server service</span>
<span class="x">      k8s:</span>
<span class="x">        namespace: &quot;</span><span class="cp">{{</span> <span class="nv">namespace</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        definition:</span>
<span class="x">          apiVersion: v1</span>
<span class="x">          kind: Service</span>
<span class="x">          metadata:</span>
<span class="x">            name: echoserver</span>
<span class="x">          spec:</span>
<span class="x">            ports:</span>
<span class="x">              - name: http</span>
<span class="x">                port: 8080</span>
<span class="x">                targetPort: 8080</span>
<span class="x">            selector:</span>
<span class="x">              app: echoserver</span>
<span class="x">    - name: Create echo server router</span>
<span class="x">      k8s:</span>
<span class="x">        namespace: &quot;</span><span class="cp">{{</span> <span class="nv">namespace</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        definition:</span>
<span class="x">          kind: Route</span>
<span class="x">          apiVersion: route.openshift.io/v1</span>
<span class="x">          metadata:</span>
<span class="x">            name: echoserver</span>
<span class="x">          spec:</span>
<span class="x">            host: echoserver.local</span>
<span class="x">            to:</span>
<span class="x">              kind: Service</span>
<span class="x">              name: echoserver</span>
<span class="x">            port:</span>
<span class="x">              targetPort: http</span>
</pre></div>


<ul>
<li>[1] <a href="https://docs.ansible.com/ansible/latest/modules/list_of_clustering_modules.html" target="_blank">https://docs.ansible.com/ansible/latest/modules/list_of_clustering_modules.html</a></li>
</ul>
    <div class="copyright">
      <p><span>原始链接:</span><a href="http://xcodest.me/use-ansible-manage-kubernetes-resources.html" target="_blank">http://xcodest.me/use-ansible-manage-kubernetes-resources.html </a></p>
      <p> <span>许可协议:</span><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
    </div>
  </div><!-- /.entry-content -->
  <div>
    <nav>
      <ul class="pager">
        <li class="previous"><a href="ansible-set-stats.html">&larr; Older</a></li>
        <li class="next"><a href="ceilometer-performance-analysis.html">Newer &rarr;</a></li>
      </ul>
    </nav>
  </div>
    <div class="comments">
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'xcodest';
        var disqus_identifier = 'use-ansible-manage-kubernetes-resources.html';
        var disqus_url = 'http://xcodest.me/use-ansible-manage-kubernetes-resources.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//xcodest.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
</section>
</div>
</div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-12 text-center footer">
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41808584-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257099267'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1257099267' type='text/javascript'%3E%3C/script%3E"));</script>
        </div>
    </div>
</body>
</html>