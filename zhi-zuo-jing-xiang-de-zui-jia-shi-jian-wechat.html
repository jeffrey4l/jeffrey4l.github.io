<html>
  <head>
    <meta http-equiv=Content-Type content="text/html;charset=utf-8">
    <link rel="stylesheet" href="theme/css/wechat.css" type="text/css" charset="utf-8">
  </head>
  <body>
    <ul>
<li>选择合适的基础镜像</li>
<li></li>
</ul>
<h2 id="_1">构建体积更小的镜像</h2>
<p>构建体积更小的镜像，有利于镜像本身的传输，尤其在 Kubernetes 的环境中，镜像的传输会更加频繁，更小的体积意味着更快的调度时间和更小的空间占用。那如何构建更加小的镜像呢?</p>
<h3 id="_2">使用更小的基础镜像</h3>
<p>不同的基础镜像构建相同的应用会有不同的大小。使用更小基础镜像会有利于减小最终镜像的大小。建议非特殊情况下，使用 alpine 镜像。他的基础镜像只有不到 5MB, 而且还自带包管理工具。一般需求都可以满足。</p>
<pre class="codehilite"><code>FROM alpine
RUN apk add nginx</code></pre>


<p>如果你的应用可以独立运行，如 Go 编译出来的 Binary 文件，还可以直接使用 scratch 这个空白镜像。</p>
<pre class="codehilite"><code>FROM scratch
COPY mybinary /mybinary
CMD [ &quot;/mybinary&quot; ]</code></pre>


<h3 id="run">合并 RUN 命令</h3>
<p>不同的 RUN 命令如果先后做了文件的增加和删除，因为镜像分层文件系统的原因，还是会增加镜像体积的。如果两个 RUN 命令合并后，才会达到所想的效果。</p>
<pre class="codehilite"><code>...
RUN curl http://xyz.abc -o abc.tar.gz \
    ...
    rm -rf abc.tar.gz
...</code></pre>


<h3 id="_3">去除掉不用的软件包</h3>
<p>在安装包的过程中，尽量只安装需要用到的包。尤其是在编译过程中，难免会安装一些运行过程中不需要的软件包，如 glibc-devel 等。那在最后，最好把这些包去掉，来节省镜像空间。又因为镜像分层系统的原因，这些安装和卸载的语法还应该处理同一个 RUN 命令下</p>
<pre class="codehilite"><code>...
RUN BUILD_DEP_PKGS=&quot;
       gcc \
       libc-devel&quot;
    &amp;&amp; yum -y install $BUILD_DEP_PKGS \
    ...
    &amp;&amp; yum -y remove $BUILD_DEP_PKGS
...</code></pre>


<h2 id="demo">Demo</h2>
<pre class="codehilite"><code>FROM centos:7

EXPOSE 8080
EXPOSE 8443

ARG http_proxy
ARG https_proxy

ARG NGINX_MODULE_VTS_VERSION=v0.1.18
ARG NGINX_VERSION=1.13.3
ARG TINI_VERSION=v0.18.0

ENV NGINX_GROUP nginx
ENV NGINX_HOME_TMP /var/spool/nginx/tmp
ENV NGINX_HOME /var/lib/nginx
ENV NGINX_USER nginx

ENV NGINX_DOWNLOAD_URL http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz

RUN BUILD_DEP_PKGS=&quot;\
        cpp \
        expat-devel \
        fontconfig-devel \
        freetype-devel \
        gcc \
        gd-devel \
        git \
        glibc-devel \
        glibc-headers \
        kernel-headers \
        keyutils-libs-devel \
        krb5-devel \
        libcom_err-devel \
        libjpeg-turbo-devel \
        libpng-devel \
        libselinux-devel \
        libsepol-devel \
        libverto-devel \
        libX11-devel \
        libXau-devel \
        libxcb-devel \
        libxcb-devel \
        libXpm-devel \
        make \
        openssl-devel \
        pcre-devel \
        xorg-x11-proto-devel \
        zlib-devel \
        &quot; \
    &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 \
    &amp;&amp; yum -y --setopt=install_weak_deps=false --setopt=tsflags=nodocs --setopt=override_install_langs=en_US.utf8 \
        install \
        ${BUILD_DEP_PKGS} \
        rsync \
        wget \
    &amp;&amp; curl -L https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini -o /tini \
    &amp;&amp; chmod +x /tini \
    &amp;&amp; wget ${NGINX_DOWNLOAD_URL} -O /tmp/nginx.tar.gz \
    &amp;&amp; tar xf /tmp/nginx.tar.gz -C /tmp \
    &amp;&amp; git clone --branch ${NGINX_MODULE_VTS_VERSION} https://github.com/vozlt/nginx-module-vts.git /tmp/nginx-module-vts \
    &amp;&amp; ( \
        cd /tmp/nginx-${NGINX_VERSION} \
        &amp;&amp; ./configure \
                --add-module=/tmp/nginx-module-vts \
                --conf-path=/etc/nginx/nginx.conf \
                --error-log-path=/var/log/nginx/error.log \
                --group=${NGINX_GROUP} \
                --http-client-body-temp-path=${NGINX_HOME_TMP}/client_body \
                --http-fastcgi-temp-path=${NGINX_HOME_TMP}/fastcgi \
                --http-log-path=/var/log/nginx/access.log \
                --http-proxy-temp-path=${NGINX_HOME_TMP}/proxy \
                --http-uwsgi-temp-path=${NGINX_HOME_TMP}/uwsgi \
                --lock-path=/var/local/subsys/nginx \
                --modules-path=/usr/lib64/nginx/modules \
                --pid-path=/var/run/nginx/nginx.pid \
                --prefix=/etc/nginx \
                --sbin-path=/usr/bin/nginx \
                --user=${NGINX_USER} \
                --with-http_gzip_static_module \
                --with-http_image_filter_module \
                --with-http_realip_module \
                --with-http_secure_link_module \
                --with-http_ssl_module \
                --with-http_stub_status_module \
                --with-http_sub_module \
                --with-http_v2_module \
                --without-http_scgi_module \
                --without-mail_imap_module \
                --without-mail_pop3_module \
                --without-mail_smtp_module \
                --without-poll_module \
                --without-select_module \
                --with-threads \
        &amp;&amp; make -j4 \
        &amp;&amp; make install \
        &amp;&amp; cp -r conf/* /etc/nginx/ \
        ) \
    &amp;&amp; rm -rf /tmp/nginx.tar.gz \
        /tmp/nginx-module-vts \
        /tmp/nginx-${NGINX_VERSION} \
    &amp;&amp; yum -y remove ${BUILD_DEP_PKGS} \
    &amp;&amp; yum clean all \
    &amp;&amp; mkdir -p ${NGINX_HOME_TMP}/{client_body,proxy,fastcgi,uwsgi} \
    &amp;&amp; mkdir -p /usr/share/nginx \
    &amp;&amp; mkdir -p /var/run/nginx \
    &amp;&amp; mkdir -p /var/www \
    &amp;&amp; mv /etc/nginx/html /usr/share/nginx/ \
    &amp;&amp; rm -rf /etc/nginx/*.default \
    &amp;&amp; chmod -R a+rwx ${NGINX_HOME_TMP} \
    &amp;&amp; chmod -R a+rwx /etc/nginx \
    &amp;&amp; chmod -R a+rwx /var/log/nginx \
    &amp;&amp; chmod -R a+rwx /var/run/nginx \
    &amp;&amp; sed -i '/listen/s,listen\s*80;,listen 8080;,g' /etc/nginx/nginx.conf \
    &amp;&amp; sed -i '/^#user/s,#\(user.*\),\1,g' /etc/nginx/nginx.conf \
    &amp;&amp; ln -sf /var/log/nginx /etc/nginx/logs \
    &amp;&amp; ln -sf /var/www /etc/nginx/www</code></pre>
    <p> 点击「阅读原文」，能看到更好的排版。 </p>
    <!--
      <div class="copyleft">
      <p>文档信息</p>
      <ul>
      <li> 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）</li>
      <li> 作者： Jeffrey4l </li>
      <li> 发表日期： 2017年12月19日 </li>
      </div>
    -->
  </body>
</html>
